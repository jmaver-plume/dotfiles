#!/bin/bash

set -e

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Create symbolic link
create_symlink() {
    local source="$1"
    local target="$2"
    
    [[ "$source" != /* ]] && source="$DOTFILES_DIR/$source"
    
    [ ! -e "$source" ] && echo "Source does not exist: $source" && return 1
    
    if [ -L "$target" ] && [ "$(readlink "$target")" = "$source" ]; then
        echo "Already linked: $target"
        return 0
    fi
    
    mkdir -p "$(dirname "$target")"
    ln -sf "$source" "$target"
    echo "Linked: $target"
}

# Install Oh My Zsh if not installed
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    echo "Installed: oh-my-zsh"
else
    echo "Already installed: oh-my-zsh"
fi

# Install Homebrew if not installed
if ! command -v brew &> /dev/null; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    echo "Installed: homebrew"
else
    echo "Already installed: homebrew"
fi

# Install Homebrew packages
packages=(
  "jq"
  "fzf"
  "zoxide"
  "ripgrep"
  "MonitorControl"
  "tldr"
  "wget"
  "diff-so-fancy"
  "nvim"
  "bat"
)
for package in "${packages[@]}"; do
    if brew list "$package" &> /dev/null; then
        echo "Already installed: $package"
        continue
    fi

    # Install the package
    brew install "$package" && echo "Installed: $package"

    # Additional setup for specific packages
    if [[ "$package" == "fzf" ]]; then
      $(brew --prefix)/opt/fzf/install
    fi
done

# Update git submodules
git submodule update --init --recursive
echo "Updated: git submodules"

# Create symbolic links
create_symlink ".hushlogin" "$HOME/.hushlogin"
create_symlink ".zshrc" "$HOME/.zshrc"
create_symlink "ghostty" "$HOME/.config/ghostty/config"
create_symlink "oh-my-zsh/custom/aws.zsh" "$HOME/.oh-my-zsh/custom/aws.zsh"
create_symlink "oh-my-zsh/custom/git.zsh" "$HOME/.oh-my-zsh/custom/git.zsh"
create_symlink "zsh-nvm" "$HOME/.oh-my-zsh/custom/plugins/zsh-nvm"
create_symlink "zsh-autosuggestions" "$HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
create_symlink "zsh-syntax-highlighting" "$HOME/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
create_symlink "zsh-you-should-use" "$HOME/.oh-my-zsh/custom/plugins/zsh-you-should-use"
create_symlink "fzf-tab" "$HOME/.oh-my-zsh/custom/plugins/fzf-tab"
create_symlink "kickstart.nvim" "$HOME/.config/nvim"

echo "Done!"
